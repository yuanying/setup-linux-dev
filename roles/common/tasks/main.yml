- name: Add Defaults to env_keep http_proxy
  # when: http_proxy
  sudo: yes
  lineinfile:
    dest: "/etc/sudoers"
    state: present
    line: 'Defaults env_keep="http_proxy"'
    validate: 'visudo -cf %s'
- name: Add Defaults to env_keep https_proxy
  # when: http_proxy
  sudo: yes
  lineinfile:
    dest: "/etc/sudoers"
    state: present
    line: 'Defaults env_keep+="https_proxy"'
    validate: 'visudo -cf %s'

- debug:
    msg: "http_proxy: {{ http_proxy }}"

- name: Add http_proxy to .bashrc
  lineinfile:
    dest: '~/.bashrc'
    state: present
    line: 'export http_proxy={{ http_proxy }}'
  when: http_proxy

- name: Remove http_proxy to .bashrc
  lineinfile:
    dest: '~/.bashrc'
    state: absent
    regexp: "^export\\s+http_proxy\\=.*"
  when: http_proxy == False

- name: Add https_proxy to .bashrc
  lineinfile:
    dest: '~/.bashrc'
    state: present
    line: 'export https_proxy={{ https_proxy }}'
  when: http_proxy

- name: Remove https_proxy to .bashrc
  lineinfile:
    dest: '~/.bashrc'
    state: absent
    regexp: "^export\\s+https_proxy\\=.*"
  when: http_proxy == False

- name: Setup proxy to apt command
  template:
    src: 90proxy.j2
    dest: /etc/apt/apt.conf.d/90proxy
